#!/bin/bash
#SBATCH --job-name=regen_var
#SBATCH --partition=3090
#SBATCH --gpus=1
#SBATCH --cpus-per-task=8
#SBATCH --mem=32G
#SBATCH --time=01:00:00
#SBATCH --output=/mnt/fast/nobackup/users/gb0048/opro2/logs/regen_var_%j.out
#SBATCH --error=/mnt/fast/nobackup/users/gb0048/opro2/logs/regen_var_%j.err

# =============================================================================
# Regenerate 22 variants with correct RIR path
# =============================================================================

set -euo pipefail
set -x

REPO="/mnt/fast/nobackup/users/gb0048/opro2"
CONTAINER="$REPO/qwen_pipeline_v2.sif"

echo "[INFO] Start: $(date)"
nvidia-smi --query-gpu=name,memory.total --format=csv
cd "$REPO"

# Remove old variants
rm -rf data/processed/variants_validated_1000

# Generate variants with correct RIR path
echo ""
echo "=========================================="
echo "Regenerating variants with RIRs"
echo "=========================================="

apptainer exec --nv \
  --pwd "$REPO" \
  "$CONTAINER" python3 scripts/generate_experimental_variants.py \
  --input_base data/processed/base_validated_1000 \
  --output_dir data/processed/variants_validated_1000 \
  --rir_dir data/rirs \
  --rir_metadata data/rirs/rir_metadata.json \
  --target_sr 16000

echo ""
echo "[DONE] End: $(date)"
