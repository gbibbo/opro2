#!/bin/bash
#SBATCH --job-name=eval_base
#SBATCH --partition=3090
#SBATCH --gpus=1
#SBATCH --cpus-per-task=8
#SBATCH --mem=48G
#SBATCH --time=04:00:00
#SBATCH --output=/mnt/fast/nobackup/users/gb0048/opro2/logs/eval_final_base_%j.out
#SBATCH --error=/mnt/fast/nobackup/users/gb0048/opro2/logs/eval_final_base_%j.err

# =============================================================================
# PURPOSE: Final evaluation of BASE model on FULL dev and test sets
# =============================================================================
# Uses:
#   - BASE Qwen2-Audio model (NO LoRA)
#   - ALL samples (no subsampling)
#   - Best prompt from OPRO optimization
#   - 22 independent conditions (4 dimensions)
# =============================================================================

set -euo pipefail
set -x

REPO="/mnt/fast/nobackup/users/gb0048/opro2"
CONTAINER="$REPO/qwen_pipeline_v2.sif"
SPLIT="${1:-dev}"  # dev or test

echo "[INFO] Start: $(date)"
nvidia-smi --query-gpu=name,memory.total --format=csv
cd "$REPO"

export HF_HOME="/mnt/fast/nobackup/users/gb0048/.cache/huggingface"
export TRANSFORMERS_CACHE="$HF_HOME/transformers"
export HF_HUB_CACHE="$HF_HOME/hub"
mkdir -p "$HF_HOME" "$TRANSFORMERS_CACHE" "$HF_HUB_CACHE"

export PYTORCH_CUDA_ALLOC_CONF="expandable_segments:True"

# Manifest
MANIFEST="$REPO/data/processed/variants_validated_1000/${SPLIT}_metadata.csv"
if [ ! -f "$MANIFEST" ]; then
    echo "[ERROR] Manifest not found: $MANIFEST"
    exit 1
fi

NSAMPLES=$(wc -l < "$MANIFEST")
echo "[INFO] Split: $SPLIT"
echo "[INFO] Manifest: $MANIFEST"
echo "[INFO] Total samples: $NSAMPLES (using ALL, no subsampling)"

# Best prompt from OPRO (or baseline if OPRO not done)
BEST_PROMPT="Does this audio contain human speech?
Reply with ONLY one word: SPEECH or NON-SPEECH."

echo "[INFO] Prompt: $BEST_PROMPT"

echo ""
echo "[RUN] Final evaluation of BASE model on $SPLIT set (ALL $NSAMPLES samples)"
apptainer exec --nv \
  --pwd "$REPO" \
  --env HF_HOME="$HF_HOME" \
  --env TRANSFORMERS_CACHE="$TRANSFORMERS_CACHE" \
  --env HF_HUB_CACHE="$HF_HUB_CACHE" \
  --env PYTORCH_CUDA_ALLOC_CONF="expandable_segments:True" \
  "$CONTAINER" python3 scripts/opro_classic_optimize.py \
  --manifest "$MANIFEST" \
  --split "$SPLIT" \
  --output_dir "results/eval_final_base_${SPLIT}" \
  --no_lora \
  --optimizer_llm Qwen/Qwen2.5-7B-Instruct \
  --num_iterations 0 \
  --max_eval_samples 0 \
  --seed 42

echo "[DONE] End: $(date)"
echo "Results: results/eval_final_base_${SPLIT}/"
